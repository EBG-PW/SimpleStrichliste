<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title id="pageTitle"></title>

    <style>
      /* Cropper.js CSS remains the same */
      .cropper-container {
        direction: ltr;
        font-size: 0;
        line-height: 0;
        position: relative;
        -ms-touch-action: none;
        touch-action: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .cropper-container img {
        backface-visibility: hidden;
        display: block;
        height: 100%;
        image-orientation: 0deg;
        max-height: none !important;
        max-width: none !important;
        min-height: 0 !important;
        min-width: 0 !important;
        width: 100%;
      }
      .cropper-canvas,
      .cropper-crop-box,
      .cropper-drag-box,
      .cropper-modal,
      .cropper-wrap-box {
        bottom: 0;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
      }
      .cropper-canvas,
      .cropper-wrap-box {
        overflow: hidden;
      }
      .cropper-drag-box {
        background-color: #fff;
        opacity: 0;
      }
      .cropper-modal {
        background-color: #000;
        opacity: 0.5;
      }
      .cropper-view-box {
        display: block;
        height: 100%;
        outline: 1px solid #39f;
        outline-color: rgba(51, 153, 255, 0.75);
        overflow: hidden;
        width: 100%;
      }
      .cropper-dashed {
        border: 0 dashed #eee;
        display: block;
        opacity: 0.5;
        position: absolute;
      }
      .cropper-dashed.dashed-h {
        border-bottom-width: 1px;
        border-top-width: 1px;
        height: 33.33333%;
        left: 0;
        top: 33.33333%;
        width: 100%;
      }
      .cropper-dashed.dashed-v {
        border-left-width: 1px;
        border-right-width: 1px;
        height: 100%;
        left: 33.33333%;
        top: 0;
        width: 33.33333%;
      }
      .cropper-center {
        display: block;
        height: 0;
        left: 50%;
        opacity: 0.75;
        position: absolute;
        top: 50%;
        width: 0;
      }
      .cropper-center:after,
      .cropper-center:before {
        background-color: #eee;
        content: " ";
        display: block;
        position: absolute;
      }
      .cropper-center:before {
        height: 1px;
        left: -3px;
        top: 0;
        width: 7px;
      }
      .cropper-center:after {
        height: 7px;
        left: 0;
        top: -3px;
        width: 1px;
      }
      .cropper-face,
      .cropper-line,
      .cropper-point {
        display: block;
        height: 100%;
        opacity: 0.1;
        position: absolute;
        width: 100%;
      }
      .cropper-face {
        background-color: #fff;
        left: 0;
        top: 0;
      }
      .cropper-line {
        background-color: #39f;
      }
      .cropper-line.line-e {
        cursor: ew-resize;
        right: -3px;
        top: 0;
        width: 5px;
      }
      .cropper-line.line-n {
        cursor: ns-resize;
        height: 5px;
        left: 0;
        top: -3px;
      }
      .cropper-line.line-w {
        cursor: ew-resize;
        left: -3px;
        top: 0;
        width: 5px;
      }
      .cropper-line.line-s {
        bottom: -3px;
        cursor: ns-resize;
        height: 5px;
        left: 0;
      }
      .cropper-point {
        background-color: #39f;
        height: 5px;
        opacity: 0.75;
        width: 5px;
      }
      .cropper-point.point-e {
        cursor: ew-resize;
        margin-top: -3px;
        right: -3px;
        top: 50%;
      }
      .cropper-point.point-n {
        cursor: ns-resize;
        left: 50%;
        margin-left: -3px;
        top: -3px;
      }
      .cropper-point.point-w {
        cursor: ew-resize;
        left: -3px;
        margin-top: -3px;
        top: 50%;
      }
      .cropper-point.point-s {
        bottom: -3px;
        cursor: s-resize;
        left: 50%;
        margin-left: -3px;
      }
      .cropper-point.point-ne {
        cursor: nesw-resize;
        right: -3px;
        top: -3px;
      }
      .cropper-point.point-nw {
        cursor: nwse-resize;
        left: -3px;
        top: -3px;
      }
      .cropper-point.point-sw {
        bottom: -3px;
        cursor: nesw-resize;
        left: -3px;
      }
      .cropper-point.point-se {
        bottom: -3px;
        cursor: nwse-resize;
        height: 20px;
        opacity: 1;
        right: -3px;
        width: 20px;
      }
      @media (min-width: 768px) {
        .cropper-point.point-se {
          height: 15px;
          width: 15px;
        }
      }
      @media (min-width: 992px) {
        .cropper-point.point-se {
          height: 10px;
          width: 10px;
        }
      }
      @media (min-width: 1200px) {
        .cropper-point.point-se {
          height: 5px;
          opacity: 0.75;
          width: 5px;
        }
      }
      .cropper-point.point-se:before {
        background-color: #39f;
        bottom: -50%;
        content: " ";
        display: block;
        height: 200%;
        opacity: 0;
        position: absolute;
        right: -50%;
        width: 200%;
      }
      .cropper-invisible {
        opacity: 0;
      }
      .cropper-bg {
        background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAA3NCSVQICAjb4U/gAAAABlBMVEXMzMz////TjRV2AAAACXBIWXMAAArrAAAK6wGCiw1aAAAAHHRFWHRTb2Z0d2FyZQBBZG9iZSBGaXJld29ya3MgQ1M26LyyjAAAABFJREFUCJlj+M/AgBVhF/0PAH6/D/HkDxOGAAAAAElFTkSuQmCC");
      }
      .cropper-hide {
        display: block;
        height: 0;
        position: absolute;
        width: 0;
      }
      .cropper-hidden {
        display: none !important;
      }
      .cropper-move {
        cursor: move;
      }
      .cropper-crop {
        cursor: crosshair;
      }
      .cropper-disabled .cropper-drag-box,
      .cropper-disabled .cropper-face,
      .cropper-disabled .cropper-line,
      .cropper-disabled .cropper-point {
        cursor: not-allowed;
      }
      .cropper-modal-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .cropper-modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 90vw;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
      }
      .cropper-image-container {
        max-width: 70vw;
        max-height: 70vh;
      }
      .cropper-image-container img {
        max-width: 100%;
        display: block;
      }
    </style>

    <script>
      const lang = <%- JSON.stringify(language) %>;
    </script>

    <script src="<%= domain %>/libjs/i18next.js?<%= curentUnixTime %>"></script>

    <script src="<%= domain %>/libjs/tailwind.js?<%= curentUnixTime %>"></script>
  </head>

  <body class="bg-gray-100">
    <%- html_content.navbar %>
    <main class="container mx-auto p-4 md:p-6">
      <header class="flex items-center mb-6">
        <a href="/admin/items" aria-label="Go back" class="text-gray-500 hover:text-gray-800 mr-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </a>
        <h1 class="text-3xl font-bold text-gray-800" data-translate="AdminUsers.PageTitle"></h1>
      </header>

      <div class="w-full max-w-2xl mx-auto">
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
          <div class="p-8 md:p-12">
            <h1 class="text-3xl font-bold text-gray-900 mb-2" data-translate="Items.Edit.Headline"></h1>

            <p class="text-gray-500 mb-8" data-translate="Items.Edit.Description"></p>

            <form id="edit-item-form" class="space-y-6">
              <div><label for="name" class="block text-sm font-medium text-gray-700" data-translate="Items.Form.Name"></label> <input type="text" name="name" id="name" class="mt-1 block w-full px-4 py-3 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required /></div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label for="packSize" class="block text-sm font-medium text-gray-700" data-translate="Items.Form.PackSize"></label> <input type="number" name="packSize" id="packSize" min="0" class="mt-1 block w-full px-4 py-3 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" /></div>

                <div><label for="packPrice" class="block text-sm font-medium text-gray-700" data-translate="Items.Form.PackPrice"></label> <input type="number" name="packPrice" id="packPrice" step="0.01" min="0" class="mt-1 block w-full px-4 py-3 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" /></div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label for="price" class="block text-sm font-medium text-gray-700" data-translate="Items.Form.Price"></label> <input type="number" name="price" id="price" step="0.01" min="0" class="mt-1 block w-full px-4 py-3 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required /></div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label for="stock" class="block text-sm font-medium text-gray-700" data-translate="Items.Form.Stock"></label> <input type="number" name="stock" id="stock" step="0.01" min="0" class="mt-1 block w-full px-4 py-3 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required /></div>

                <div><label for="targetStock" class="block text-sm font-medium text-gray-700" data-translate="Items.Form.TargetStock"></label> <input type="number" name="targetStock" id="targetStock" min="0" class="mt-1 block w-full px-4 py-3 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required /></div>
              </div>

              <div>
                <label for="category-button" class="block text-sm font-medium text-gray-700" data-translate="Items.Form.Category"></label> <input type="hidden" name="category" id="category" required />
                <div class="relative mt-1">
                  <button type="button" id="category-button" class="relative w-full cursor-default rounded-lg bg-white py-3 pl-4 pr-10 text-left border-gray-300 border shadow-sm focus:outline-none focus-visible:border-indigo-500 focus-visible:ring-2 focus-visible:ring-white focus-visible:ring-opacity-75 focus-visible:ring-offset-2 focus-visible:ring-offset-indigo-300">
                    <span id="category-selected-display" class="block truncate" data-translate="Items.Form.SelectCategory"></span>
                    <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </span>
                  </button>

                  <ul id="category-options" class="absolute z-10 mt-1 hidden max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"></ul>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700" data-translate="Items.Form.Image"></label>
                <div class="mt-2 flex items-center gap-6"><img id="image-preview" src="/i/items/<%= params.uuid %>" alt="Image preview" class="h-24 w-24 rounded-full object-cover" /> <input type="file" name="image" id="image" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" /></div>
              </div>

              <div class="pt-6 flex justify-end">
                <button type="submit" id="submit-button" class="inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-md font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300"><span data-translate="Items.Button.Save"></span></button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>

    <div id="cropper-modal" class="cropper-modal-container">
      <div class="cropper-modal-content">
        <h2 class="text-xl font-bold mb-4" data-translate="Items.Form.AdjustImage"></h2>
        <div class="cropper-image-container">
          <img id="image-to-crop" />
        </div>
        <div class="flex justify-end gap-4 mt-4">
          <button type="button" id="cancel-crop-button" class="py-2 px-4 rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200" data-translate="Items.Button.Cancel"></button>
          <button type="button" id="crop-button" class="py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700" data-translate="Items.Button.CropSave"></button>
        </div>
      </div>
    </div>

    <script src="<%= domain %>/appjs/permission.js?<%= curentUnixTime %>" defer></script>
    <script src="<%= domain %>/appjs/translate.js?<%= curentUnixTime %>"></script>
    <script src="<%= domain %>/libjs/cropper.min.js?<%= curentUnixTime %>"></script>

    <script>
      let cropper;
      let croppedImageBlob = null;

      const apiEndpoint = `/api/v1/items/<%= params.uuid %>`;

      const editItemForm = document.getElementById("edit-item-form");
      const categoryButton = document.getElementById("category-button");
      const categoryOptions = document.getElementById("category-options");
      const categorySelectedDisplay = document.getElementById("category-selected-display");
      const hiddenCategoryInput = document.getElementById("category");
      const imageInput = document.getElementById("image");
      const imagePreview = document.getElementById("image-preview");
      const cropperModal = document.getElementById("cropper-modal");
      const imageToCrop = document.getElementById("image-to-crop");
      const cropButton = document.getElementById("crop-button");
      const cancelCropButton = document.getElementById("cancel-crop-button");
      const submitButton = document.getElementById("submit-button");
      const packSizeInput = document.getElementById("packSize");
      const packPriceInput = document.getElementById("packPrice");
      const priceInput = document.getElementById("price");

      /**
       * Fetches active categories and populates the dropdown select.
       */
      async function populateCategories() {
        try {
          const response = await apiFetch("/api/v1/categories");
          if (!response.ok) throw new Error("Could not load categories");

          const data = await response.json();
          const allCategories = data.categories;
          let countActive = 0;

          allCategories.forEach((cat) => {
            if (!cat.enabled) return; // Skip disabled categories
            const li = document.createElement("li");
            li.className = "relative cursor-default select-none py-2 pl-10 pr-4 text-gray-900 hover:bg-indigo-100";
            li.dataset.value = cat.name;

            li.innerHTML = `
              <span class="absolute inset-y-0 left-0 flex items-center pl-2 text-gray-600">
                  ${cat.icon}
              </span>
              <span class="block truncate font-normal pl-10">
                  ${i18next.t(`Categories.${cat.name}`)}
              </span>
            `;

            li.addEventListener("click", () => {
              hiddenCategoryInput.value = li.dataset.value;
              categorySelectedDisplay.innerHTML = li.innerHTML;
              categoryOptions.classList.add("hidden");
            });

            categoryOptions.appendChild(li);
            countActive++;
          });

          if (countActive === 0) {
            const li = document.createElement("li");
            li.className = "relative cursor-default select-none py-2 pl-10 pr-4 text-gray-900";
            li.innerHTML = `<span class="block truncate font-normal pl-10">${i18next.t("Categories.None")}</span>`;
            categoryOptions.appendChild(li);
          }

          const urlParams = new URLSearchParams(window.location.search);
          const categoryFromUrl = urlParams.get("category");

          if (categoryFromUrl) {
            const categoryLi = categoryOptions.querySelector(`li[data-value="${decodeURIComponent(categoryFromUrl)}"]`);
            if (categoryLi) {
              categoryLi.click();
            }
          }
        } catch (error) {
          console.error(error);
        }

        categoryButton.addEventListener("click", () => {
          categoryOptions.classList.toggle("hidden");
        });

        window.addEventListener("click", (e) => {
          if (!categoryButton.contains(e.target)) {
            categoryOptions.classList.add("hidden");
          }
        });
      }

      function calculateItemPrice() {
        const packSize = parseFloat(packSizeInput.value);
        const packPrice = parseFloat(packPriceInput.value);

        if (packSize > 0 && packPrice > 0) {
          const itemPrice = packPrice / packSize;
          priceInput.value = (Math.ceil(itemPrice * 100) / 100).toFixed(2); // Make sure to round up to the nearest cent
        }
      }

      function handleImageSelection(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          imageToCrop.src = e.target.result;
          cropperModal.style.display = "flex";

          if (cropper) {
            cropper.destroy();
          }

          cropper = new Cropper(imageToCrop, {
            aspectRatio: 1,
            viewMode: 1,
            background: false,
            responsive: true,
            restore: true,
          });
        };
        reader.readAsDataURL(file);
      }

      async function fetchAndPopulateItemData() {
        try {
          const response = await apiFetch(apiEndpoint);
          if (!response.ok) {
            // Handle item not found or other errors
            document.querySelector("main").innerHTML = `<p class="text-center text-red-500">Item not found.</p>`;
            throw new Error("Item not found");
          }
          const item = await response.json();

          document.getElementById("name").value = item.name;
          document.getElementById("price").value = item.price;
          document.getElementById("packSize").value = item.pack_size;
          document.getElementById("packPrice").value = item.pack_price;
          document.getElementById("stock").value = item.stock;
          document.getElementById("targetStock").value = item.target_stock;

          if (item.imageUrl) {
            imagePreview.src = item.imageUrl;
          }

          if (item.category_name) {
            const categoryLi = categoryOptions.querySelector(`li[data-value="${item.category_name}"]`);
            if (categoryLi) {
              categoryLi.click();
            }
          }
        } catch (error) {
          console.error("Failed to fetch item data:", error);
        }
      }

      async function handleFormSubmit(event) {
        event.preventDefault();

        const originalButtonClasses = ["bg-indigo-600", "hover:bg-indigo-700"];
        const originalButtonHTML = submitButton.innerHTML;

        submitButton.disabled = true;
        submitButton.innerHTML = `<span>${i18next.t("Items.Button.Saving")}</span>`;

        const formData = new FormData(editItemForm);
        if (croppedImageBlob) {
          // A new image has been selected and cropped
          formData.set("image", croppedImageBlob, "cropped_image.png");
        } else {
          // No new image was selected, remove 'image'
          formData.delete("image");
        }

        try {
          const response = await apiFetch(apiEndpoint, {
            method: "PUT",
            body: formData,
          });

          if (response.ok) {
            submitButton.classList.remove(...originalButtonClasses);
            submitButton.classList.add("bg-green-600");
            submitButton.innerHTML = `<span>${i18next.t("Items.Response.SuccessSave")}</span>`;
          } else {
            const result = await response.json();
            submitButton.classList.remove(...originalButtonClasses);
            submitButton.classList.add("bg-red-600");
            submitButton.innerHTML = `<span>${result.message || "Error"}</span>`;
          }
        } catch (error) {
          console.error("Submission failed:", error);
          submitButton.classList.remove(...originalButtonClasses);
          submitButton.classList.add("bg-red-600");
          submitButton.innerHTML = `<span>${error.message}</span>`;
        } finally {
          setTimeout(() => {
            submitButton.disabled = false;
            submitButton.classList.remove("bg-green-600", "bg-red-600");
            submitButton.classList.add(...originalButtonClasses);
            submitButton.innerHTML = originalButtonHTML;
          }, 3000);
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await populateCategories();
        await fetchAndPopulateItemData();

        packSizeInput.addEventListener("input", calculateItemPrice);
        packPriceInput.addEventListener("input", calculateItemPrice);
        imageInput.addEventListener("change", handleImageSelection);
        editItemForm.addEventListener("submit", handleFormSubmit);
        cropButton.addEventListener("click", () => {
          if (!cropper) return;

          const canvas = cropper.getCroppedCanvas({
            width: 512,
            height: 512,
          });

          imagePreview.src = canvas.toDataURL();

          canvas.toBlob(
            (blob) => {
              croppedImageBlob = blob;
            },
            "image/jpeg",
            0.9
          );

          cropperModal.style.display = "none";
        });

        cancelCropButton.addEventListener("click", () => {
          cropperModal.style.display = "none";
          imageInput.value = "";
        });
      });
    </script>
  </body>
</html>
